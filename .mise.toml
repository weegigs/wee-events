[env]
_.file = ".env"

[tools]
pnpm = "10.2.1"
node = "22.15.1"
lefthook = "latest"

[hooks]
enter = "lefthook install"

[tasks.clean-rebuild]
description = "Full clean and rebuild of the entire monorepo"
run = [
    "pnpm run clean",
    "rm -rf node_modules",
    "find packages tools -name node_modules -type d -exec rm -rf {} + 2>/dev/null || true",
    "pnpm install",
    "pnpm run build",
]

[tasks.release-preflight]
description = "Comprehensive pre-release validation and safety checks"
run = [
    "echo 'ğŸ” === PRE-RELEASE VALIDATION ==='",
    "echo 'ğŸ“‹ 1. Git repository validation:'",
    "git status --porcelain | grep -q . && echo 'âŒ Working directory not clean. Commit or stash changes.' && exit 1 || echo 'âœ… Working directory clean'",
    "git symbolic-ref HEAD | grep -q refs/heads/main && echo 'âœ… On main branch' || (echo 'âŒ Not on main branch' && exit 1)",
    "git fetch origin && git diff --quiet HEAD origin/main && echo 'âœ… Up to date with origin' || (echo 'âŒ Local main differs from origin/main' && exit 1)",
    "echo 'ğŸ”’ 2. Security and dependency validation:'",
    "pnpm audit || (echo 'âŒ High/critical security vulnerabilities found' && exit 1)",
    "echo 'âœ… No high/critical security vulnerabilities'",
    "echo 'ğŸ“¦ 3. Package validation:'",
    "echo 'âœ… Using conventional commits for versioning'",
    "echo 'ğŸ—ï¸  4. Build system validation:'",
    "pnpm run clean || echo 'Clean failed, continuing...'",
    "pnpm install --frozen-lockfile || (echo 'âŒ Failed to install with frozen lockfile' && exit 1)",
    "echo 'âœ… Dependencies installed successfully'",
    "echo 'ğŸ§ª 5. Comprehensive testing:'",
    "pnpm run build || (echo 'âŒ Build failed' && exit 1)",
    "echo 'âœ… Build successful'",
    "pnpm run test || (echo 'âŒ Tests failed' && exit 1)",
    "echo 'âœ… All tests passing'",
    "pnpm run lint || (echo 'âŒ Linting failed' && exit 1)",
    "echo 'âœ… Linting passed'",
    "echo 'ğŸ“Š 6. Release validation:'",
    "echo 'ğŸ“Š Recent commits:'",
    "git log --oneline --grep='feat\\|fix\\|BREAKING CHANGE' -10 || echo 'No conventional commits found'",
    "echo 'ğŸ¯ === PREFLIGHT COMPLETE ==='",
    "echo 'âœ… All validations passed. Safe to proceed with release.'",
    "echo 'ğŸ“ Next: mise run release-dry-run'",
]

[tasks.release-dry-run]
description = "Full release simulation without any changes"
run = [
    "echo 'ğŸ§ª === RELEASE DRY RUN ==='",
    "echo 'ğŸ“‹ Analyzing conventional commits:'",
    "git log --oneline --grep='feat\\|fix\\|BREAKING CHANGE' -10 || echo 'No conventional commits found'",
    "echo 'ğŸ“ Simulating version updates:'",
    "pnpm run release:dry",
    "echo 'ğŸ—ï¸  Testing clean build from scratch:'",
    "pnpm run clean",
    "pnpm install --frozen-lockfile",
    "pnpm run build",
    "echo 'ğŸ§ª Running full test suite:'",
    "pnpm run test",
    "echo 'ğŸ” Validating code quality:'",
    "pnpm lint",
    "echo 'ğŸ¯ === DRY RUN COMPLETE ==='",
    "echo 'âœ… Dry run successful! Release would succeed.'",
    "echo 'ğŸ“ Next: mise run release-version'",
]

[tasks.release-version]
description = "Update package versions and generate changelogs"
run = [
    "echo 'ğŸš€ === VERSION UPDATE PHASE ==='",
    "echo 'âš ï¸  This will modify package.json files and generate CHANGELOGs'",
    "echo 'ğŸ“ Current git status:'",
    "git status --short",
    "echo 'ğŸ”„ Running release-it...'",
    "pnpm run release",
    "echo 'ğŸ¯ === VERSION UPDATE COMPLETE ==='",
    "echo 'âœ… Release completed successfully'",
    "echo 'ğŸ“ Next: mise run release-verify'",
]

[tasks.release-publish]
description = "NOTE: Publishing is now handled by release-version task with release-it"
run = [
    "echo 'ğŸ“¦ === PUBLICATION NOTICE ==='",
    "echo 'âœ… Publishing is now integrated into the release-version task'",
    "echo 'ğŸ“ release-it handles the entire release process:'",
    "echo '   - Version bumping'", 
    "echo '   - Changelog generation'",
    "echo '   - Git tagging'",
    "echo '   - NPM publishing'",
    "echo '   - GitHub releases'",
    "echo 'ğŸ“ Use: mise run release-version for complete release'",
    "echo 'ğŸ“ Or: pnpm run release:ci for automated release'",
]

[tasks.release-verify]
description = "Post-release verification and validation"
run = [
    "echo 'âœ… === POST-RELEASE VERIFICATION ==='",
    "echo 'ğŸ” Verifying published packages:'",
    "sleep 10",
    "echo 'ğŸ“¦ Checking package availability on npm:'",
    "find packages -name package.json -exec jq -r .name {} \\; | while read pkg; do echo \"Checking $pkg...\"; npm view \"$pkg\" version --silent || echo \"âŒ $pkg not found on registry\"; done",
    "echo 'ğŸ“Š Release summary:'",
    "echo 'Published packages:'",
    "git log --oneline -1",
    "echo 'Git tags:'",
    "git tag --sort=-version:refname | head -5",
    "echo 'ğŸ¯ === VERIFICATION COMPLETE ==='",
    "echo 'âœ… Release verification successful!'",
    "echo 'ğŸ“ Consider: announcement, documentation updates, monitoring'",
]

[tasks.release-rollback]
description = "Emergency rollback procedures"
run = [
    "echo 'ğŸš¨ === EMERGENCY ROLLBACK ==='",
    "echo 'âš ï¸  WARNING: This will attempt to rollback the release'",
    "echo 'ğŸ“ Last release commit:'",
    "git log --oneline -1",
    "echo 'âŒ MANUAL STEPS REQUIRED:'",
    "echo '1. Unpublish packages: npm unpublish <package>@<version>'",
    "echo '2. Revert git commits: git revert HEAD'",
    "echo '3. Delete git tags: git tag -d <tag> && git push origin :refs/tags/<tag>'",
    "echo '4. Restore previous versions in package.json files'",
    "echo '5. Notify stakeholders'",
    "echo 'ğŸ¯ This task provides guidance only - manual intervention required'",
]

[tasks.release-full]
description = "Complete automated release pipeline using release-it (USE WITH CAUTION)"
run = [
    "echo 'ğŸš€ === FULL AUTOMATED RELEASE ==='",
    "echo 'âš ï¸  WARNING: This will execute the complete release pipeline'",
    "echo 'â±ï¸  You have 10 seconds to cancel (Ctrl+C)...'",
    "sleep 10",
    "mise run release-preflight",
    "mise run release-dry-run", 
    "echo 'âš ï¸  Proceeding with automated release using release-it...'",
    "pnpm run release:ci",
    "mise run release-verify",
    "echo 'ğŸ‰ === FULL RELEASE COMPLETE ==='",
    "echo 'âœ… Automated release pipeline finished successfully!'",
]
