[env]
_.file = ".env"

[tools]
pnpm = "latest"
node = "24.2.0"

[tasks.clean-rebuild]
description = "Full clean and rebuild of the entire monorepo"
run = [
    "pnpm run clean",
    "rm -rf node_modules pnpm-lock.yaml",
    "find packages tools -name node_modules -type d -exec rm -rf {} + 2>/dev/null || true",
    "pnpm install",
    "pnpm run build",
]

[tasks.release-preflight]
description = "Comprehensive pre-release validation and safety checks"
run = [
    "echo 'ğŸ” === PRE-RELEASE VALIDATION ==='",
    "echo 'ğŸ“‹ 1. Git repository validation:'",
    "git status --porcelain | grep -q . && echo 'âŒ Working directory not clean. Commit or stash changes.' && exit 1 || echo 'âœ… Working directory clean'",
    "git symbolic-ref HEAD | grep -q refs/heads/main && echo 'âœ… On main branch' || (echo 'âŒ Not on main branch' && exit 1)",
    "git fetch origin && git diff --quiet HEAD origin/main && echo 'âœ… Up to date with origin' || (echo 'âŒ Local main differs from origin/main' && exit 1)",
    "echo 'ğŸ”’ 2. Security and dependency validation:'",
    "pnpm audit || (echo 'âŒ High/critical security vulnerabilities found' && exit 1)",
    "echo 'âœ… No high/critical security vulnerabilities'",
    "echo 'ğŸ“¦ 3. Package validation:'",
    "pnpm changeset status | grep -q 'No changesets present' && echo 'âŒ No changesets found for release' && exit 1 || echo 'âœ… Changesets present'",
    "echo 'ğŸ—ï¸  4. Build system validation:'",
    "pnpm run clean || echo 'Clean failed, continuing...'",
    "pnpm install --frozen-lockfile || (echo 'âŒ Failed to install with frozen lockfile' && exit 1)",
    "echo 'âœ… Dependencies installed successfully'",
    "echo 'ğŸ§ª 5. Comprehensive testing:'",
    "pnpm run build || (echo 'âŒ Build failed' && exit 1)",
    "echo 'âœ… Build successful'",
    "pnpm run test || (echo 'âŒ Tests failed' && exit 1)",
    "echo 'âœ… All tests passing'",
    "pnpm run lint || (echo 'âŒ Linting failed' && exit 1)",
    "echo 'âœ… Linting passed'",
    "echo 'ğŸ“Š 6. Release validation:'",
    "pnpm changeset status",
    "echo 'ğŸ¯ === PREFLIGHT COMPLETE ==='",
    "echo 'âœ… All validations passed. Safe to proceed with release.'",
    "echo 'ğŸ“ Next: mise run release-dry-run'",
]

[tasks.release-dry-run]
description = "Full release simulation without any changes"
run = [
    "echo 'ğŸ§ª === RELEASE DRY RUN ==='",
    "echo 'ğŸ“‹ Current changeset status:'",
    "pnpm changeset status",
    "echo 'ğŸ“ Simulating version updates:'",
    "echo 'The following packages would be updated:'",
    "pnpm changeset status | grep -E '^  @weegigs/' || echo 'No packages to update'",
    "echo 'ğŸ—ï¸  Testing clean build from scratch:'",
    "pnpm run clean",
    "pnpm install --frozen-lockfile",
    "pnpm run build",
    "echo 'ğŸ§ª Running full test suite:'",
    "pnpm run test",
    "echo 'ğŸ” Validating code quality:'",
    "pnpm lint",
    "echo 'ğŸ“¦ Simulating package publication:'",
    "pnpm changeset publish --dry-run",
    "echo 'ğŸ¯ === DRY RUN COMPLETE ==='",
    "echo 'âœ… Dry run successful! Release would succeed.'",
    "echo 'ğŸ“ Next: mise run release-version'",
]

[tasks.release-version]
description = "Update package versions and generate changelogs"
run = [
    "echo 'ğŸš€ === VERSION UPDATE PHASE ==='",
    "echo 'âš ï¸  This will modify package.json files and generate CHANGELOGs'",
    "echo 'ğŸ“ Current git status:'",
    "git status --short",
    "echo 'ğŸ”„ Running changeset version...'",
    "pnpm changeset version",
    "echo 'ğŸ“Š Changes made:'",
    "git status --short",
    "git diff --name-only",
    "echo 'ğŸ“‹ Version changes:'",
    "git diff --unified=0 packages/*/package.json | grep '^[+-].*\"version\"'",
    "echo 'ğŸ¯ === VERSION UPDATE COMPLETE ==='",
    "echo 'âœ… Versions updated successfully'",
    "echo 'âš ï¸  IMPORTANT: Review the changes above carefully'",
    "echo 'ğŸ“ Review CHANGELOGs: find packages -name CHANGELOG.md -exec echo \"=== {} ===\" \\; -exec head -20 {} \\;'",
    "echo 'ğŸ“ Next: git add . && git commit -m \"Version packages\" && mise run release-publish'",
]

[tasks.release-publish]
description = "Publish packages to npm registry with full validation"
run = [
    "echo 'ğŸ“¦ === PUBLICATION PHASE ==='",
    "echo 'ğŸ” Final pre-publish validation:'",
    "git status --porcelain | grep -q . && echo 'âš ï¸  Uncommitted changes detected' || echo 'âœ… All changes committed'",
    "echo 'ğŸŒ Testing npm registry connectivity:'",
    "npm ping || (echo 'âŒ Cannot reach npm registry' && exit 1)",
    "echo 'âœ… npm registry accessible'",
    "echo 'ğŸ”‘ Validating npm authentication:'",
    "npm whoami || (echo 'âŒ Not logged into npm. Run: npm login' && exit 1)",
    "echo 'âœ… npm authentication valid'",
    "echo 'ğŸ§ª Final build validation:'",
    "pnpm run build",
    "pnpm run test",
    "echo 'ğŸ“¦ Publishing packages...'",
    "pnpm changeset publish",
    "echo 'ğŸ·ï¸  Creating git tag and pushing:'",
    "git add .",
    "git diff --cached --quiet || git commit -m 'chore: release packages'",
    "LATEST_VERSION=$(jq -r '.version' packages/core/package.json)",
    "git tag v$LATEST_VERSION",
    "git push origin main",
    "git push origin v$LATEST_VERSION",
    "echo 'ğŸ¯ === PUBLICATION COMPLETE ==='",
    "echo 'ğŸ‰ Release published successfully!'",
    "echo 'ğŸ“ Next: mise run release-verify'",
]

[tasks.release-verify]
description = "Post-release verification and validation"
run = [
    "echo 'âœ… === POST-RELEASE VERIFICATION ==='",
    "echo 'ğŸ” Verifying published packages:'",
    "sleep 10",
    "echo 'ğŸ“¦ Checking package availability on npm:'",
    "find packages -name package.json -exec jq -r .name {} \\; | while read pkg; do echo \"Checking $pkg...\"; npm view \"$pkg\" version --silent || echo \"âŒ $pkg not found on registry\"; done",
    "echo 'ğŸ“Š Release summary:'",
    "echo 'Published packages:'",
    "git log --oneline -1",
    "echo 'Git tags:'",
    "git tag --sort=-version:refname | head -5",
    "echo 'ğŸ¯ === VERIFICATION COMPLETE ==='",
    "echo 'âœ… Release verification successful!'",
    "echo 'ğŸ“ Consider: announcement, documentation updates, monitoring'",
]

[tasks.release-rollback]
description = "Emergency rollback procedures"
run = [
    "echo 'ğŸš¨ === EMERGENCY ROLLBACK ==='",
    "echo 'âš ï¸  WARNING: This will attempt to rollback the release'",
    "echo 'ğŸ“ Last release commit:'",
    "git log --oneline -1",
    "echo 'âŒ MANUAL STEPS REQUIRED:'",
    "echo '1. Unpublish packages: npm unpublish <package>@<version>'",
    "echo '2. Revert git commits: git revert HEAD'",
    "echo '3. Delete git tags: git tag -d <tag> && git push origin :refs/tags/<tag>'",
    "echo '4. Restore previous versions in package.json files'",
    "echo '5. Notify stakeholders'",
    "echo 'ğŸ¯ This task provides guidance only - manual intervention required'",
]

[tasks.release-full]
description = "Complete automated release pipeline (USE WITH CAUTION)"
run = [
    "echo 'ğŸš€ === FULL AUTOMATED RELEASE ==='",
    "echo 'âš ï¸  WARNING: This will execute the complete release pipeline'",
    "echo 'â±ï¸  You have 10 seconds to cancel (Ctrl+C)...'",
    "sleep 10",
    "mise run release-preflight",
    "mise run release-dry-run",
    "mise run release-version",
    "echo 'âš ï¸  Pausing before publish. Review changes and press Enter to continue...'",
    "read -p 'Continue with publish? (y/N): ' confirm",
    "[ \"$confirm\" = \"y\" ] || [ \"$confirm\" = \"Y\" ] || (echo 'Cancelled.' && exit 1)",
    "git add . && git commit -m 'chore: version packages'",
    "mise run release-publish",
    "mise run release-verify",
    "echo 'ğŸ‰ === FULL RELEASE COMPLETE ==='",
    "echo 'âœ… Automated release pipeline finished successfully!'",
]
